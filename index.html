<html>

<head>
    <meta charset="utf-8" />
    <title>The Miracle Map</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

    <!-- Load Leaflet from CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==" crossorigin=""></script>

    <!-- Load Esri Leaflet from CDN -->
    <script src="https://unpkg.com/esri-leaflet@2.4.0/dist/esri-leaflet.js" integrity="sha512-kq0i5Xvdq0ii3v+eRLDpa++uaYPlTuFaOYrfQ0Zdjmms/laOwIvLMAxh7cj1eTqqGG47ssAcTY4hjkWydGt6Eg==" crossorigin=""></script>

    <!--    Load Google Fonts-->
    <link href="https://fonts.googleapis.com/css2?family=Abril+Fatface&family=Open+Sans&display=swap" rel="stylesheet">

    <style>
        * {
            font-family: 'Open Sans', sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 50px;
            bottom: 0;
            width: 100%;
            z-index: 1001;
        }

        .navbarParent {
            background: white;
            box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.2);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            margin: auto;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            height: 50px;
            align-content: center;
        }

        .fullTitle {
            padding-top: 8px;
            padding-left: 16px;
        }

        #miracle-icon {
            width: 35px;
            height: 35px;
        }

        .fullTitleText {
            margin-top: -40px;
            margin-left: 45px;
            align-content: center;
        }

        .navbar-title {
            font-size: 30px;
            font-weight: bold;
            color: #35605A;
            letter-spacing: 1.25px;
        }

        .vl {
            color: #989898;
            font-size: 24px;
            font-weight: lighter;
            margin-right: 6px;
            margin-left: 6px;
        }

        .navbar-subtitle {
            font-size: 17px;
            font-weight: normal;
            font-style: italic;
            color: #989898;
        }

        .links {
            padding-top: 8px;
            padding-left: 16px;
        }

        #form-icon {
            width: 35px;
            height: 35px;
        }

        #time-ranges {
            position: absolute;
            bottom: 40px;
            left: 10px;
            z-index: 1001;
            background: white;
            font-size: .75em;
            color: #35605A;
            font-weight: bold;
            padding: .5em .5em .1em .5em;
        }

        #time-ranges input {
            display: inline-block;
            border: 1px solid #989898;
            font-size: 1em;
            border-radius: 4px;
            height: 28px;
            line-height: 28px;
            color: #35605A;
            margin-bottom: -10;
        }

        #time-ranges input[type='submit'] {
            box-sizing: content-box;
            padding: 0 .5em;
            text-transform: uppercase;
            color: white;
            background: #35605A;
            border-color: #35605A;
        }

        #query {
            position: fixed;
            top: 9px;
            right: 40px;
            z-index: 1001;
            font-size: .75em;
            font-weight: bold;
            color: #35605A;
            padding: .5em;
        }

        #query select {
            font-size: 1em;
            font-family: 'Open Sans', sans-serif;
            color: #35605A;
        }

        #query-location {
            position: absolute;
            top: 140px;
            right: 10px;
            z-index: 1000;
            background: #f5f5f5;
            padding: 1em;
            font-family: 'Open Sans', sans-serif;
            font-size: .75em;
            font-weight: bold;
            color: #35605A;
            opacity: .8;

        }

        #query-location select {
            font-size: 1em;
            font-family: 'Open Sans', sans-serif;
            color: #35605A;
        }

        .button {
            background-color: #35605A;
            padding: 2px;
            bottom: 10px;
            left: 10px;
            position: absolute;
            z-index: 1000;
            border-radius: 5px;
            height: 20px;
            width: 125px;
        }

        .button:hover {
            background-color: #11fd9d;
            color: white;
        }

        h3 {
            font-size: 1.5em;
            font-weight: bold;
            color: #35605A;
            margin-bottom: -10;
        }

        h4 {
            font-size: 1em;
            font-weight: lighter;
            left: 1px;
            color: white;
            letter-spacing: .75px;
            margin: 1.5;
        }

        p {
            font-size: 1em;
            color: #343434;
        }


        a {
            font-size: 1em;
            color: #35605A;
            word-wrap: break-word;
        }

        a:visited {
            font-size: 1em;
            color: #11fd9d;
            word-wrap: break-word;
        }

        a:hover {
            font-size: 1em;
            color: #11fd9d;
        }
    </style>
</head>

<body>
    <!--    title bar style inspired by Lis Fano's glacier map: https://efano.github.io/GNP-glaciers/index.html#-->
    <div class="navbarParent">
        <div class="navbar">
            <div class="fullTitle">
                <div class="logo">
                    <img id="miracle-icon" src="images/miracle-fish.svg">
                </div>
                <div class="fullTitleText">
                    <span class="navbar-title">The Miracle Map</span>
                    <span class="vl">|</span>
                    <span class="navbar-subtitle">A user-generated, interactive web map of miracles from around the world</span>
                </div>
            </div>
            <div class="links">
                <div class="logo-links">
                    <img id="form-icon" src="images/form-icon.svg">
                </div>
            </div>
        </div>
    </div>

    <div id="map">
        <a href='https://arcg.is/1fnqKS' target="_blank">
            <div class="button">
                <center>
                    <h4>SUBMIT A MIRACLE</h4>
                </center>
            </div>
        </a>
    </div>

    <div id="time-ranges" class="leaflet-bar">
        <form action="#" id="form">
            <label for="from">
                From
                <input id="from" type="date" value="0001-01-01" name="from">
            </label>
            <label for="to">
                To
                <input id="to" type="date" value="2020-06-25" name="to">
            </label>
            <input type="submit" value="Update">
        </form>
    </div>

    <div id="query" class="leaflet-bar">
        <label>
            Condition:
            <select id="condition">
                <!-- make sure to encase string values in single quotes for valid sql -->
                <option value="1=1">Any</option>
                <option value="Condition='0'">Addiction</option>
                <option value="Condition='16'">Autoimmune/Inflammatory Disease</option>
                <option value="Condition='1'">Birth Defect</option>
                <option value="Condition='2'">Blindness</option>
                <option value="Condition='3'">Blood Disease</option>
                <option value="Condition='4'">Cancer</option>
                <option value="Condition='5'">Chronic Pain</option>
                <option value="Condition='6'">Deafness</option>
                <option value="Condition='7'">Death bed</option>
                <option value="Condition='8'">Diabetes</option>
                <option value="Condition='9'">Digestive Disorder</option>
                <option value="Condition='10'">Endocrine Disease</option>
                <option value="Condition='11'">Evil Spirit</option>
                <option value="Condition='12'">Eye Disease</option>
                <option value="Condition='13'">Fever</option>
                <option value="Condition='14'">Genetic</option>
                <option value="Condition='15'">Heart Disease</option>
                <option value="Condition='17'">Infectious Disease</option>
                <option value="Condition='18'">Infectious Disease/Environmental-Related</option>
                <option value="Condition='19'">Infertility</option>
                <option value="Condition='20'">Injury</option>
                <option value="Condition='21'">Kidney/Urinary Disease</option>
                <option value="Condition='22'">Leprosy</option>
                <option value="Condition='23'">Liver Disease</option>
                <option value="Condition='24'">Lung Disease</option>
                <option value="Condition='25'">Mental Illness</option>
                <option value="Condition='26'">Neurological Disease</option>
                <option value="Condition='27'">Non-infectious Communicable Disease</option>
                <option value="Condition='28'">Paralysis</option>
                <option value="Condition='29'">Raised from the Dead</option>
                <option value="Condition='30'">Skin Disease</option>
                <option value="Condition='31'">Spirit of Infirmity</option>
                <option value="Condition='32'">Viral Disease</option>
                <option value="Condition='33'">Other</option>
            </select>
        </label>
    </div>

    <!--<div id="query-location" class="leaflet-bar">
    <label>
        Location:
        <select id="location">
            make sure to encase string values in single quotes for valid sql
            <option value="1=1">Any</option>
            <option value="region='0'">Antarctica</option>
            <option value="region='1'">Asiatic Russia</option>
            <option value="region='3'">Australia/New Zealand</option>
            <option value="region='4'">Caribbean</option>
            <option value="region='5'">Central America</option>
            <option value="region='6'">Central Asia</option>
            <option value="region='7'">Eastern Africa</option>
            <option value="region='8'">Eastern Asia</option>
            <option value="region='9'">Eastern Europe</option>
            <option value="region='10'">European Russia</option>
            <option value="region='11'">Melanesia</option>
            <option value="region='12'">Middle Africa</option>
            <option value="region='13'">Middle East</option>
            <option value="region='14'">Northern Africa</option>
            <option value="region='15'">Northern America</option>
            <option value="region='16'">Northern Europe</option>
            <option value="region='17'">Polynesia</option>
            <option value="region='18'">South America</option>
            <option value="region='19'">Southern Asia</option>
            <option value="region='20'">Southern Europe</option>
            <option value="region='21'">Western Africa</option>
            <option value="region='22'">Western Asia</option>
            <option value="region='23'">Western Europe</option>
        </select>
    </label>
</div>-->

    <script>
        // add time range variables
        var timeForm = document.getElementById('form');
        var startTimeInput = document.getElementById('from');
        var endTimeInput = document.getElementById('to');

        // create map and set extent
        var map = L.map('map').setView([0, 0], 5);

        // add basemap and labels conducive to firefly symbology
        L.esri.basemapLayer('ImageryFirefly').addTo(map);
        L.esri.basemapLayer('ImageryLabels').addTo(map);

        // create an icon for the points
        // a cross?
        var icon = L.icon({
            iconUrl: './images/firefly-4.png',
            iconSize: [35, 35]
        });

        drawMap();

        function drawMap() {
            // need to create a public view of the hosted feature layer in AGO to access point data here
            var data = L.esri.featureLayer({
                // the url below is for the public hosted layer view
                url: 'https://services9.arcgis.com/fSxmsxg6MME8SObM/arcgis/rest/services/miracles_view_layer/FeatureServer/0',
                // add where clause here to filter by review_status = Approved
                where: "review_status = '1'",
                timeField: "Date_of_miracle",
                from: new Date(startTimeInput.value),
                to: new Date(endTimeInput.value),
                pointToLayer: function(geojson, latlng) {
                    return L.marker(latlng, {
                        icon: icon
                    });
                },
                onEachFeature: function(feature, layer) {
                    var links = '<a href = {links} target=blank>{links}</a>';
                    var popup = L.Util.template('<h3>{Name}</h3><p>Test<br>More info here<br><br>Link to video testimony:<br><a href = {links} target=blank>{links}</a></p>', layer.feature.properties);
                    layer.on('mouseover', function() {
                        // console.log(layer.feature.properties.review_status);
                        layer.bindPopup(function(layer) {
                            return popup;
                        });
                    })
                }
            }).addTo(map);

            // reset map extent to the bounds of the features
            data.query().bounds(function(error, latlngbounds) {
                if (error) {
                    return;
                }
                map.fitBounds(latlngbounds);
            });

            // call the listeners for the drop-down menus
            listeners(data);
        }

        function listeners(data) {
            // add listener here for time range
            timeForm.addEventListener('submit', function updateTimeRange(e) {
                data.setTimeRange(new Date(startTimeInput.value), new Date(endTimeInput.value));
                e.preventDefault();
            });

            // add listener here for condition drop-down menu
            var condition = document.getElementById('condition');
            condition.addEventListener('change', function() {
                data.setWhere(condition.value);
            });

            // add listener here for location drop-down menu
            //            var location = document.getElementById('location');
            // location.addEventListener('change', function() {
            // data.setWhere(location.value);
            // });
        }
    </script>

</body></html>
