<html>

<head>
    <meta charset="utf-8" />
    <title>The Miracle Map</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <!-- Load Leaflet from CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin="" />
    <!-- Load Mapbox GL -->
    <link rel="stylesheet" href="https://unpkg.com/mapbox-gl/dist/mapbox-gl.css" />
    <script src="https://unpkg.com/mapbox-gl/dist/mapbox-gl.js"></script>
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==" crossorigin=""></script>
    <!-- Load Carto.js -->
    <script src="https://libs.cartocdn.com/carto.js/v4.2.0/carto.min.js"></script>
    <!-- Load Esri Leaflet from CDN -->
    <script src="https://unpkg.com/esri-leaflet@2.4.0/dist/esri-leaflet.js" integrity="sha512-kq0i5Xvdq0ii3v+eRLDpa++uaYPlTuFaOYrfQ0Zdjmms/laOwIvLMAxh7cj1eTqqGG47ssAcTY4hjkWydGt6Eg==" crossorigin=""></script>
    <script src="https://unpkg.com/esri-leaflet-vector/dist/esri-leaflet-vector.js"></script>
    <!--    Load Google Fonts-->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
    <!--    Load Material Icons-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--    Load noUiSlider-->
    <link href="./nouislider/distribute/nouislider.css" rel="stylesheet">
    <script src="./nouislider/distribute/nouislider.js"></script>
    <!--    Load wNumb-->
    <script src="./wnumb/wNumb.js"></script>
    <!-- Load Ajax-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <style>
        * {
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            margin: 0;
            padding: 0;
        }
        
        #map {
            position: absolute;
            top: 76px;
            bottom: 0;
            width: 100%;
            z-index: 1001;
        }
        
        .navbarParent {
            background: #1e1b1c;
            box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.2);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            margin: auto;
        }
        
        .navbar {
            display: flex;
            justify-content: space-between;
            height: 76px;
            align-content: center;
        }
        
        .fullTitle {
            padding-top: 0px;
            padding-left: 16px;
            margin: auto;
        }
        
        #miracle-icon {
            height: 80px;
            width: 360px;
        }
        
        .fullTitleText {
            margin-top: -40px;
            margin-left: 45px;
            align-content: center;
        }
        
        .navbar-title {
            font-size: 30px;
            font-weight: bold;
            color: #35605A;
            letter-spacing: 1.25px;
        }
        
        .vl {
            color: #989898;
            font-size: 24px;
            font-weight: lighter;
            margin-right: 6px;
            margin-left: 6px;
        }
        
        .navbar-subtitle {
            font-size: 17px;
            font-weight: normal;
            font-style: italic;
            color: #989898;
        }
        
        .links {
            padding-top: 20px;
            padding-left: 5px;
            padding-right: 4px;
        }
        
        #query {
            position: fixed;
            top: 20px;
            left: 125px;
            z-index: 1001;
            font-size: .85em;
            font-weight: bold;
            color: whitesmoke;
            padding: .5em;
        }
        
        #query select {
            font-size: 1em;
            font-family: 'Poppins', sans-serif;
            color: #1e1b1c;
        }
        
        h3 {
            font-size: 1.25em;
            font-weight: bold;
            color: #1e1b1c;
        }
        
        h4 {
            font-size: .8em;
            color: #1e1b1c;
            margin-top: 7px;
        }
        
        h5 {
            font-size: .7em;
            color: #1e1b1c;
        }
        
        p {
            font-size: 1em;
            color: #1e1b1c;
        }
        
        a {
            font-size: 1em;
            color: #0033fd;
            word-wrap: break-word;
        }
        
        a:visited {
            font-size: 1em;
            color: #35605A;
            word-wrap: break-word;
        }
        
        a:hover {
            font-size: 1em;
            color: #0033fd;
            opacity: .8;
        }
        
        #slider {
            position: absolute;
            bottom: 20px;
            left: 25px;
            width: 20%;
            z-index: 1002;
        }
        
        .material-icons.md-36 {
            font-size: 36px;
        }
        
        .material-icons.green356 {
            color: #35605A;
        }
        
        .material-icons.fireflygreen {
            color: #0033fd;
        }
        
        .material-icons.whitesmoke {
            color: whitesmoke;
        }
        
        .material-icons:hover {
            opacity: .8
        }
        
        #lil-box {
            z-index: 1001;
            width: 100px;
            height: 165px;
            background-color: whitesmoke;
            border-radius: 5px;
            padding: 6px;
            position: absolute;
            bottom: 90px;
            left: 15px;
            visibility: visible;
            opacity: 100;
            transition: visibility 0s, opacity .5s linear;
        }
        
        #big-box {
            z-index: 1001;
            width: 200px;
            height: 200px;
            background-color: whitesmoke;
            padding: 6px;
            border-radius: 5px;
            position: absolute;
            bottom: 90px;
            left: 15px;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity .5s linear;
            transition-delay: .5s;
        }
        
        .leaflet-popup-content-wrapper {
            background-color: whitesmoke;
        }
    </style>
</head>

<body>
    <!--    title bar style inspired by Lis Fano's glacier map: https://efano.github.io/GNP-glaciers/index.html#-->
    <div class="navbarParent">
        <div class="navbar">
            <div class="links"> <i class="material-icons md-36 whitesmoke" title="Reset Map" onmouseover="" style="cursor: pointer" onclick="window.location.reload();">refresh</i>
                <a href='https://arcg.is/1fnqKS' target="_blank"> <i class="material-icons md-36 whitesmoke" title="Submit a Miracle">add_box</i></a> <i class="material-icons md-36 whitesmoke" title="About" style="cursor: pointer">info</i> </div>
            <div class="fullTitle">
                <div class="logo"> <img id="miracle-icon" src="images/mm-logo/PNG/PNG/test.png"> </div>
                <!--<div class="fullTitleText"> <span class="navbar-title">The Miracle Map</span> <span class="vl">|</span> <span class="navbar-subtitle">A user-generated, interactive web map of miracles from around the world</span> </div>--></div>
        </div>
    </div>
    <div id="map"> </div>
    <div id="lil-box">
        <h4>There are a total of <span id='miracle-number'></span> miracles on the map.</h4>
        <h5>Click on a miracle point for more information.</h5> </div>
    <div id="big-box"> </div>
    <div id="query" class="leaflet-bar">
        <label> Condition:
            <select id="condition">
                <!-- make sure to encase string values in single quotes for valid sql -->
                <option value="1=1">Any</option>
                <option value="Condition='0'">Addiction</option>
                <option value="Condition='16'">Autoimmune/Inflammatory Disease</option>
                <option value="Condition='1'">Birth Defect</option>
                <option value="Condition='2'">Blindness</option>
                <option value="Condition='3'">Blood Disease</option>
                <option value="Condition='4'">Cancer</option>
                <option value="Condition='5'">Chronic Pain</option>
                <option value="Condition='6'">Deafness</option>
                <option value="Condition='7'">Death bed</option>
                <option value="Condition='8'">Diabetes</option>
                <option value="Condition='9'">Digestive Disorder</option>
                <option value="Condition='10'">Endocrine Disease</option>
                <option value="Condition='11'">Evil Spirit</option>
                <option value="Condition='12'">Eye Disease</option>
                <option value="Condition='13'">Fever</option>
                <option value="Condition='14'">Genetic</option>
                <option value="Condition='15'">Heart Disease</option>
                <option value="Condition='17'">Infectious Disease</option>
                <option value="Condition='18'">Infectious Disease/Environmental-Related</option>
                <option value="Condition='19'">Infertility</option>
                <option value="Condition='20'">Injury</option>
                <option value="Condition='21'">Kidney/Urinary Disease</option>
                <option value="Condition='22'">Leprosy</option>
                <option value="Condition='23'">Liver Disease</option>
                <option value="Condition='24'">Lung Disease</option>
                <option value="Condition='25'">Mental Illness</option>
                <option value="Condition='26'">Neurological Disease</option>
                <option value="Condition='27'">Non-infectious Communicable Disease</option>
                <option value="Condition='28'">Paralysis</option>
                <option value="Condition='29'">Raised from the Dead</option>
                <option value="Condition='30'">Skin Disease</option>
                <option value="Condition='31'">Spirit of Infirmity</option>
                <option value="Condition='32'">Viral Disease</option>
                <option value="Condition='33'">Other</option>
            </select>
        </label>
    </div>
    <div id="slider"></div>
    <!--<div id="query-location" class="leaflet-bar">
    <label>
        Location:
        <select id="location">
            make sure to encase string values in single quotes for valid sql
            <option value="1=1">Any</option>
            <option value="region='0'">Antarctica</option>
            <option value="region='1'">Asiatic Russia</option>
            <option value="region='3'">Australia/New Zealand</option>
            <option value="region='4'">Caribbean</option>
            <option value="region='5'">Central America</option>
            <option value="region='6'">Central Asia</option>
            <option value="region='7'">Eastern Africa</option>
            <option value="region='8'">Eastern Asia</option>
            <option value="region='9'">Eastern Europe</option>
            <option value="region='10'">European Russia</option>
            <option value="region='11'">Melanesia</option>
            <option value="region='12'">Middle Africa</option>
            <option value="region='13'">Middle East</option>
            <option value="region='14'">Northern Africa</option>
            <option value="region='15'">Northern America</option>
            <option value="region='16'">Northern Europe</option>
            <option value="region='17'">Polynesia</option>
            <option value="region='18'">South America</option>
            <option value="region='19'">Southern Asia</option>
            <option value="region='20'">Southern Europe</option>
            <option value="region='21'">Western Africa</option>
            <option value="region='22'">Western Asia</option>
            <option value="region='23'">Western Europe</option>
        </select>
    </label>
</div>-->
    <script>
        // create map and set extent
        var map = L.map('map').setView([0, 0], 5);
        // add esri basemap
        L.esri.basemapLayer('ImageryFirefly').addTo(map);
        // add labels for basemap?
        // L.esri.basemapLayer('ImageryLabels').addTo(map);
        var icon = L.icon({
            iconUrl: './images/all-firefly/FireflyC6.png'
            , iconSize: [30, 30]
        });
        drawMap();

        function drawMap() {
            // need to create a public view of the hosted feature layer in AGO to access point data here
            var data = L.esri.featureLayer({
                // the url below is for the public hosted layer view
                url: 'https://services9.arcgis.com/fSxmsxg6MME8SObM/arcgis/rest/services/miracles_view_layer/FeatureServer/0', // add where clause here to filter by review_status = Approved
                where: "review_status = '1'"
                , pointToLayer: function (geojson, latlng) {
                    return L.marker(latlng, {
                        icon: icon
                    });
                }
                , onEachFeature: function (feature, layer) {
                    // var popupClick = '<h3>{Name}</h3><p>Test<br>More info here<br><br>Link to video testimony:<br><a href = {links} target=blank>{links}</a></p>';
                    var popupHover = '<h3>{Name}</h3>';
                    var popup = L.Util.template(popupHover, layer.feature.properties);
                    layer.on('mouseover', function () {
                        console.log(layer.feature.properties.miracle_year);
                        layer.bindPopup(function (layer) {
                            return popup;
                        }).openPopup();
                    })
                    layer.on('mouseout', function () {
                        layer.closePopup();
                    })
                    layer.on('click', function () {
                        console.log(layer.feature.properties);
                        var miracle_name = layer.feature.properties.Name;
                        var miracle_link = layer.feature.properties.links;
                        var miracle_type = layer.feature.properties.Miracle_Type;
                        var popupClick = '<h3>' + miracle_name + '</h3>' + 'Miracle Type: ' + miracle_type + '<br>' + '<a href=' + miracle_link + ' target=blank>Video Testimony</a>';
                        document.getElementById('big-box').innerHTML = popupClick;
                    })
                }
            }).addTo(map);
            // call the zoom to data extent function
            zoom(data);
            // and then zoom in a tad
            // map.setZoom(map.getZoom() + 1);
            // call the listeners for the drop-down menus
            listeners(data);
            addSlider(data);
            featureCount(data);
        }

        function zoom(data) {
            // reset map extent to the bounds of the features
            data.query().bounds(function (error, latlngbounds) {
                if (error) {
                    return;
                }
                map.fitBounds(latlngbounds);
            });
        }

        function listeners(data) {
            // add listener here for condition drop-down menu
            var condition = document.getElementById('condition');
            condition.addEventListener('change', function () {
                data.setWhere(condition.value);
            });
            // add another listener here for when users click on a miracle
            const littleBox = document.getElementById('lil-box');
            const bigBox = document.getElementById('big-box');
            data.addEventListener('click', () => {
                // console.log("hi michael");
                littleBox.style.visibility = 'invisible';
                littleBox.style.opacity = 0;
                bigBox.style.visibility = 'visible';
                bigBox.style.opacity = 100;
            })
        }

        function addSlider(data) {
            var slider = document.getElementById('slider');
            noUiSlider.create(slider, {
                connect: true
                , format: wNumb({
                    decimals: 0
                })
                , tooltips: [true, true]
                , behavior: 'tap'
                , start: [1, 2020]
                , range: {
                    'min': [1, 132]
                    , '10%': [132, 1864]
                    , '50%': [1996, 1]
                    , 'max': [2020]
                }
            });
            mergeTooltips(slider, 15, ' - ');
            // add on change function here
            slider.noUiSlider.on('change', function () {
                // create a variable to access the slider values
                var sliderYears = slider.noUiSlider.get();
                console.log(sliderYears);
                // pass a function here to update the map based on the slider values
                updateMap(data, sliderYears);
            });
        }

        function updateMap(data, sliderYears) {
            // use setWhere to query the data ala the condition drop-down menu
            data.setWhere("review_status = '1' AND miracle_year BETWEEN " + sliderYears[0] + " AND " + sliderYears[1]);
        }

        function mergeTooltips(slider, threshold, separator) {
            var textIsRtl = getComputedStyle(slider).direction === 'rtl';
            var isRtl = slider.noUiSlider.options.direction === 'rtl';
            var isVertical = slider.noUiSlider.options.orientation === 'vertical';
            var tooltips = slider.noUiSlider.getTooltips();
            var origins = slider.noUiSlider.getOrigins();
            // Move tooltips into the origin element. The default stylesheet handles this.
            tooltips.forEach(function (tooltip, index) {
                if (tooltip) {
                    origins[index].appendChild(tooltip);
                }
            });
            slider.noUiSlider.on('update', function (values, handle, unencoded, tap, positions) {
                var pools = [[]];
                var poolPositions = [[]];
                var poolValues = [[]];
                var atPool = 0;
                // Assign the first tooltip to the first pool, if the tooltip is configured
                if (tooltips[0]) {
                    pools[0][0] = 0;
                    poolPositions[0][0] = positions[0];
                    poolValues[0][0] = values[0];
                }
                for (var i = 1; i < positions.length; i++) {
                    if (!tooltips[i] || (positions[i] - positions[i - 1]) > threshold) {
                        atPool++;
                        pools[atPool] = [];
                        poolValues[atPool] = [];
                        poolPositions[atPool] = [];
                    }
                    if (tooltips[i]) {
                        pools[atPool].push(i);
                        poolValues[atPool].push(values[i]);
                        poolPositions[atPool].push(positions[i]);
                    }
                }
                pools.forEach(function (pool, poolIndex) {
                    var handlesInPool = pool.length;
                    for (var j = 0; j < handlesInPool; j++) {
                        var handleNumber = pool[j];
                        if (j === handlesInPool - 1) {
                            var offset = 0;
                            poolPositions[poolIndex].forEach(function (value) {
                                offset += 1000 - 10 * value;
                            });
                            var direction = isVertical ? 'bottom' : 'right';
                            var last = isRtl ? 0 : handlesInPool - 1;
                            var lastOffset = 1000 - 10 * poolPositions[poolIndex][last];
                            offset = (textIsRtl && !isVertical ? 100 : 0) + (offset / handlesInPool) - lastOffset;
                            // Center this tooltip over the affected handles
                            tooltips[handleNumber].innerHTML = poolValues[poolIndex].join(separator);
                            tooltips[handleNumber].style.display = 'block';
                            tooltips[handleNumber].style[direction] = offset + '%';
                        }
                        else {
                            // Hide this tooltip
                            tooltips[handleNumber].style.display = 'none';
                        }
                    }
                });
            });
        }

        function featureCount(data) {
            var query = L.esri.query({
                url: 'https://services9.arcgis.com/fSxmsxg6MME8SObM/arcgis/rest/services/miracles_view_layer/FeatureServer/0'
            });
            query.count(function (error, count, response) {
                if (error) {
                    console.log(error);
                    return;
                }
                console.log('found ' + count + ' features')
                document.getElementById('miracle-number').innerHTML = count;
                var miracleNumber = document.getElementById('miracle-number');
                miracleNumber.style.color = '#0033fd';
                miracleNumber.style.fontWeight = 'bolder';
            })
        }
    </script>
</body>

</html>